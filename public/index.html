<!DOCTYPE html>
<html>
  <head>
    <base target="_top">
    <style>
      body {
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Oxygen, Ubuntu, Cantarell, "Fira Sans", "Droid Sans", "Helvetica Neue", sans-serif;
        background-color: #f4f4f9; color: #333; line-height: 1.6; margin: 0; padding: 20px;
      }
      .container { max-width: 600px; margin: 20px auto; padding: 25px; background: #fff; border-radius: 8px; box-shadow: 0 4px 10px rgba(0,0,0,0.1); }
      h1 { text-align: center; color: #4a4a4a; margin-bottom: 25px; }
      .form-group { margin-bottom: 20px; }
      label { display: block; margin-bottom: 8px; font-weight: 600; color: #555; }
      input[type="text"], input[type="email"], input[type="tel"], input[type="date"] { width: 100%; padding: 12px; border: 1px solid #ccc; border-radius: 5px; box-sizing: border-box; font-size: 16px; }
      .time-slots { margin-top: 10px; display: grid; grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); gap: 10px; }
      .slot-btn { padding: 12px 10px; border: 1px solid #007bff; background-color: #fff; color: #007bff; border-radius: 5px; cursor: pointer; font-size: 14px; font-weight: 600; transition: all 0.2s ease-in-out; }
      .slot-btn:hover { background-color: #e6f2ff; }
      .slot-btn.selected { background-color: #007bff; color: #fff; }
      #submit-btn { width: 100%; padding: 15px; background-color: #28a745; color: white; border: none; border-radius: 5px; cursor: pointer; font-size: 18px; font-weight: bold; }
      #submit-btn:disabled { background-color: #9ddcb0; cursor: not-allowed; }
      #message-area { margin-top: 20px; padding: 15px; border-radius: 5px; text-align: center; font-weight: bold; display: none; }
      #message-area.success { background-color: #d4edda; color: #155724; }
      #message-area.error { background-color: #f8d7da; color: #721c24; }
    </style>
  </head>
  <body>
    <div class="container">
      <h1>Book Your Appointment</h1>
      <form id="booking-form">
        <div class="form-group"> <label for="name">Full Name</label> <input type="text" id="name" name="name" required> </div>
        <div class="form-group"> <label for="email">Email Address</label> <input type="email" id="email" name="email" required> </div>
        <div class="form-group"> <label for="mobile">Mobile Number</label> <input type="tel" id="mobile" name="mobile" required> </div>
        <hr>
        <div class="form-group"> <label for="booking-date">Select a Date</label> <input type="date" id="booking-date" name="booking-date" onchange="fetchSlots()"> </div>
        <div class="form-group"> <label>Select a Time Slot</label> <div id="time-slots-container" class="time-slots"> <p>Please select a date first.</p> </div> </div>
        <button type="button" id="submit-btn" onclick="submitBooking()" disabled>Confirm Booking</button>
      </form>
      <div id="message-area"></div>
    </div>
    <script>
      let selectedTimeSlot = null;
      document.addEventListener("DOMContentLoaded", function() { const today = new Date().toISOString().split('T')[0]; document.getElementById('booking-date').setAttribute('min', today); });
      function fetchSlots() {
        const selectedDate = document.getElementById('booking-date').value;
        const slotsContainer = document.getElementById('time-slots-container');
        if (!selectedDate) return;
        slotsContainer.innerHTML = '<p>Loading available slots...</p>';
        selectedTimeSlot = null;
        updateSubmitButtonState();
        const url = `/.netlify/functions/bookingAPI?action=getSlots&date=${selectedDate}`;
        fetch(url).then(response => { if (!response.ok) throw new Error(`Slot check failed: ${response.statusText}`); return response.json(); }).then(data => { if (data.error) throw new Error(data.error); displaySlots(data); }).catch(err => showError(err));
      }
      function displaySlots(slots) {
        const slotsContainer = document.getElementById('time-slots-container');
        slotsContainer.innerHTML = '';
        if (slots.length === 0) { slotsContainer.innerHTML = '<p>No slots available for this date.</p>'; return; }
        slots.forEach(slot => { const btn = document.createElement('button'); btn.type = 'button'; btn.className = 'slot-btn'; btn.textContent = `${slot.time} (${slot.vacancies} left)`; btn.dataset.time = slot.time; btn.onclick = () => selectSlot(btn); slotsContainer.appendChild(btn); });
      }
      function selectSlot(button) { document.querySelectorAll('.slot-btn').forEach(btn => btn.classList.remove('selected')); button.classList.add('selected'); selectedTimeSlot = button.dataset.time; updateSubmitButtonState(); }
      function updateSubmitButtonState() { const name = document.getElementById('name').value; const email = document.getElementById('email').value; const date = document.getElementById('booking-date').value; const submitBtn = document.getElementById('submit-btn'); if (name && email && date && selectedTimeSlot) { submitBtn.disabled = false; } else { submitBtn.disabled = true; } }
      document.getElementById('name').addEventListener('input', updateSubmitButtonState); document.getElementById('email').addEventListener('input', updateSubmitButtonState); document.getElementById('mobile').addEventListener('input', updateSubmitButtonState);
      function submitBooking() {
        const form = document.getElementById('booking-form');
        if (!form.checkValidity()) { showMessage('Please fill in all required fields.', 'error'); return; }
        const bookingData = { name: document.getElementById('name').value, email: document.getElementById('email').value, mobile: document.getElementById('mobile').value, date: document.getElementById('booking-date').value, time: selectedTimeSlot };
        const submitBtn = document.getElementById('submit-btn'); submitBtn.disabled = true; submitBtn.textContent = 'Processing...';
        const url = `/.netlify/functions/bookingAPI?action=processBooking`;
        fetch(url, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(bookingData), }).then(response => { if (!response.ok) throw new Error(`Booking failed: Server error.`); return response.json(); }).then(data => { if (data.error) throw new Error(data.error); showSuccess(data); }).catch(err => showError(err));
      }
      function showSuccess(message) { showMessage(message, 'success'); document.getElementById('submit-btn').style.display = 'none'; document.getElementById('booking-form').reset(); document.getElementById('time-slots-container').innerHTML = '<p>Thank you!</p>'; }
      function showError(error) { showMessage(error.message, 'error'); const submitBtn = document.getElementById('submit-btn'); submitBtn.disabled = false; submitBtn.textContent = 'Confirm Booking'; fetchSlots(); }
      function showMessage(msg, type) { const messageArea = document.getElementById('message-area'); messageArea.textContent = msg; messageArea.className = type; messageArea.style.display = 'block'; }
    </script>
  </body>
</html>
